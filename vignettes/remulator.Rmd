---
title: "Fitting and plotting curves to data in magclass format"
author: "David Klein"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting curves to data in magclass format}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Purpose and Functionality

# Variante A: calculate emulator for one single case consisting of all scenarios present in the data
This requires the data to have the following structure (no "sample" dimension)

```{r, echo = TRUE}
str(data)

#Formal class 'magpie' [package "magclass"] with 1 slot
#..@ .Data: num [1:11, 1:12, 1:21462] 0.6256 0.0959 0.0376 0.0329 0.1341 ...
#.. ..- attr(*, "dimnames")=List of 3
#.. .. ..$ region                 : chr [1:11] "AFR" "CPA" "EUR" "FSU" ...
#.. .. ..$ year                   : chr [1:12] "y1995" "y2005" "y2015" "y2025" ...
#.. .. ..$ scenario.model.variable: chr [1:21462] "CDL_base-base-1.MAgPIE.Emissions|BC|Land Use (Mt BC/yr)" "CDL_base-base-1.MAgPIE.Emissions|BC|Land 
```

```{r, echo = TRUE}
emulator(data=data,
         name_x="Primary Energy|Biomass|Energy Crops (EJ/yr)",
         name_y="Price|Primary Energy|Biomass (US$2005/GJ)",
         name_modelstat="Modelstatus (-)",
         treat_as_infes = c(5,7),
         output_path = "single_case",
         lower=c(0,0,1))
```

Variante B: calculate emulator for multiple cases. Distinguish cases by scenario names 
and use samples within a single scenario for fitting.
This requires the data to have the following structure including a "sample" dimension

```{r, echo = TRUE}
# Formal class 'magpie' [package "magclass"] with 1 slot
# ..@ .Data: num [1:11, 1:11, 1:21462] 1.013 0.119 0.0419 0.1572 0.3047 ...
# .. ..- attr(*, "dimnames")=List of 3
# .. .. ..$ region                        : chr [1:11] "AFR" "CPA" "EUR" "FSU" ...
# .. .. ..$ year                          : chr [1:11] "y2005" "y2015" "y2025" "y2035" ...
# .. .. ..$ scenario.sample.model.variable: chr [1:21462] "CDL_base-base.1.MAgPIE.Emissions|BC|Land Use (Mt BC/yr)" 
```

In this case this structure can easily be achieved by separating the numbers from the 
scenario names and putting them into the new "sample" dimension

Bring object to format that is required by emulator
add sample dimension by replacing -63 with .63
```{r, echo = TRUE}
getNames(data,dim="scenario") <- gsub("-([0-9]{1,2}$)",".\\1",getNames(data,dim="scenario"))
getSets(data) <- c("region","year","scenario","sample","model","variable")
```

```{r, echo = TRUE}
emulator(data=data,
         name_x="Primary Energy|Biomass|Energy Crops (EJ/yr)",
         name_y="Price|Primary Energy|Biomass (US$2005/GJ)",
         name_modelstat="Modelstatus (-)",
         treat_as_infes = c(5,7),
         output_path = "multi_case",
         lower=c(0,0,1))
```

## Components
Below follows a brief overview about the essential components of this package. 

### Input data
You can use your data already loaded to the R workspace or add the results of your model runs by storing it in .rda format in the iamc/data folder. When later we speak about input data it will be these data.

### Validation (in PDF file only)
This package offers the option to validate your data against historical and other reference data. The results of the validation can (only!) be viewed in a pdf file. This file summarizes the results of the pre-checks, checks, and the validation. If the user does not activate the generation of this pdf file the validation will not be performed but only the results of the pre-checks and checks will be printed on the screen. A collection of global historical and other reference data is provided by the package and used as default reference data for the validation. Call iamReferenceData() to view it. 

## A simple example

The package comes with a small example data set `example_REMIND` supposed to be checked against a configuration 'example_CFG'. This is a strongly reduced example for demonstration purposes (to be found in the iamc/inst/extdata folder). If no configuration is explicitly assigned the default from the CDLINKS convention is taken. This file can also be found in the iamc/inst/extdata folder.
To show the functionality of the package some mistakes have been introduced into the example data set. The following command detects these mistakes by triggering all pre-checks and checks that are stored in "iamc/R/":

```{r, echo=TRUE}
library(iamc)
iamCheck(example_REMIND, cfg="example_CFG")
```

This returns information about the checks performed and the problems found in the data. In this example the pre-checks are reporting information about variables: e.g. in "preCheckIllegalVariables" we specified a test, that checks if the input data in "example_REMIND" has variables not listed in the configuration file "example_CFG", thus are illegal. The test "preCheckMissingVariables" indentifies all variables listed in the configuration-file but missing in the input data. The checks "checkMin" and "checkMax" test if the values of the input data correspond to the minimal and maximal values specified in the configuration files.