---
title: "Fitting curves to magclass data and plotting the curves to nice graphs and pdf"
author: "David Klein"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fitting curves to data in magclass format}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# Purpose and Functionality
With this package you can fit a curve to your data. It is a wrapper around the `optim()` function from R's stats package and offers an easy-to-use interface to data in magclass format. Use the main function `emulator()` of this package to fit a curve of the form `y = a + b * x ^d`, where `x` and `y` are the data you provide and `a`,`b`, and `d` are the coefficients the `emulator()` function will calculate using the `optim()` function from R's stats package. The resulting curves together with the raw data will be plotted and saved to figures and compiled in a pdf.

# Input data
The data is required to be of the magclass format. The data you want to fit the curves to needs to have at least three variables:

* data that will be used for `x` and `y` in the fit
* a variable that provides the codes of the GAMS model status (<https://www.gams.com/24.8/docs/userguides/mccarl/modelstat_tmodstat.htm>). Data from infeasible years and their successors will be excluded from the fit.

The `emulator()` function requires the data to be of a particular format. There are two alternative formats allowed. The following sections explain the differences and give examples how to apply the emulator function.

# Examples

## Alternative A: Calculate emulator for one single case consisting of all scenarios present in the data
This requires the data to have the following structure. Note: the data has no "sample" dimension (see alternative B), just scenario, model, and variable. All scenarios in your data will be lumped together and the fit will be perfomred on all data points from all scenarios. 

```{r, echo = TRUE}
library(remulator)
library(magclass)
str(emudata)

```

When calling the `emulator()` funtion you need to provide the data as such of course, the name of the variables (present in your data) that will be treated as `x` and `y` in the fit, and the name of the variable that holds the model status. Optionally you can provide the model status codes that will be treated as infeasible. By default it is 5. All results will be saved to `output_path`. Optionally you can provide arguments of the `optim()` function, such as lower or upper bounds. The function performs the following steps:

* it sorts out data of infeasible years and all years following an infeasible year
* for each region and each year it fits a curve of the form `y = a + b * x ^d`, where `x` and `y` are the data you provide and `a`,`b`, and `d` are the coefficients the `emulator()` function will calculate using the `optim()` function from R's stats package
* using the fit coefficients from above it will calculate continous curves for plotting
* it plots the curves to png files and additionally compiles them to a pdf file

```{r, echo = TRUE, eval=FALSE}
emulator(data=emudata,
         name_x="Primary Energy|Biomass|Energy Crops (EJ/yr)",
         name_y="Price|Primary Energy|Biomass (US$2005/GJ)",
         name_modelstat="Modelstatus (-)",
         treat_as_infes = c(5,7),
         output_path = "single_case",
         lower=c(0,0,1))
```

## Alternative B: Calculate emulator for multiple cases. Distinguish cases by scenarios present in the data.
If your data contains the additional dimension named "sample", the `emulator()` function will distinguish data by the scenario names and perform the fit based on the data points of all samples per scenario. Thus, there will be a fit for each scenario. This requires the data to have the following structure including a "sample" dimension

```{r, echo = TRUE}
# Formal class 'magpie' [package "magclass"] with 1 slot
# ..@ .Data: num [1:11, 1:11, 1:21462] 1.013 0.119 0.0419 0.1572 0.3047 ...
# .. ..- attr(*, "dimnames")=List of 3
# .. .. ..$ region                        : chr [1:11] "AFR" "CPA" "EUR" "FSU" ...
# .. .. ..$ year                          : chr [1:11] "y2005" "y2015" "y2025" "y2035" ...
# .. .. ..$ scenario.sample.model.variable: chr [1:21462] "CDL_base-base.1.MAgPIE.Emissions|BC|Land Use (Mt BC/yr)" 
```

We use the data from above that has no native sample dimension and add the missing sample dimension by separating the numbers from the 
scenario names and putting them into the new "sample" dimension. This results in two scenarios with 73 samples each.

Magclass objects distinguish dimensions by dots in the variable names. Thus, we add a new dimension to magclass object by inserting a dot. In this case we do this by replacing the dash in the scenario name with a dot, e.g. from "-63" to ".63" (see the gsub command below).

```{r, echo = TRUE}
# Add dimension by replacing dashes with dots
getNames(emudata,dim="scenario") <- 
  gsub("-([0-9]{1,2}$)",".\\1",getNames(emudata,dim="scenario"))
# Naming the dimensions
getSets(emudata) <- c("region","year","scenario","sample","model","variable")
```

The call if the `emulator()` function is the same, except using a different output directory.

```{r, echo = TRUE, eval=FALSE}
emulator(data=emudata,
         name_x="Primary Energy|Biomass|Energy Crops (EJ/yr)",
         name_y="Price|Primary Energy|Biomass (US$2005/GJ)",
         name_modelstat="Modelstatus (-)",
         treat_as_infes = c(5,7),
         output_path = "multi_case",
         lower=c(0,0,1))
```

The output from alternative A and B are different: the output of A (single case) consists of only one scenario named "default". Since in B the fits have been performed separately for the two scenarios the output folder contains two sub folders, one for each scenario.
